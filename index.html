<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Tiny by GhostZCH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Tiny</h1>
      <h2 class="project-tagline">抽象服务程序原型, 提供一些基本功能</h2>
      <a href="https://github.com/GhostZCH/Tiny" class="btn">View on GitHub</a>
      <a href="https://github.com/GhostZCH/Tiny/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/GhostZCH/Tiny/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="tiny" class="anchor" href="#tiny" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tiny</h1>

<p><img src="http://img0.pcgames.com.cn/pcgames/1112/13/2382339_130224659.jpg" alt=""></p>

<p>一个针对Linux的轻量级python服务器架构，提供服务器需要一些基本功能，诸如：热更新、安全退出、日志处理、定时器、运行状态统计和监控等。尽可能的简单，只要最实用的功能，代码总量控制在1k内。和supervise工具协同，效果更佳</p>

<h2>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>features</h2>

<h3>
<a id="basic" class="anchor" href="#basic" aria-hidden="true"><span class="octicon octicon-link"></span></a>basic</h3>

<h4>
<a id="代码结构" class="anchor" href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84" aria-hidden="true"><span class="octicon octicon-link"></span></a>代码结构</h4>

<ul>
<li><p>my_*.py 是本框架的示例</p></li>
<li><p>svr_*.py 是本框架的源代码</p></li>
</ul>

<h4>
<a id="使用方式" class="anchor" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用方式</h4>

<p>开发人员通过继承ServerBase得到基本功能，如：</p>

<pre><code>from bin.svr_base import ServerBase

class MyServer(ServerBase):
</code></pre>

<p>ServerBase 提供一些抽象函数供开发者实现自定义的处理：</p>

<pre><code># ------------- abstract function --------------
def on_reload(self):
    pass

def on_close(self):
    pass

def on_start(self):
    pass

def on_except(self, ex, trace_back):
    pass

def get_summary(self):
    pass

def run(self):
    pass
</code></pre>

<p><strong>备注：可参照 my_server.py</strong> </p>

<h3>
<a id="hot-update" class="anchor" href="#hot-update" aria-hidden="true"><span class="octicon octicon-link"></span></a>hot-update</h3>

<p><code>./svr.sh reload</code></p>

<h3>
<a id="safe-close" class="anchor" href="#safe-close" aria-hidden="true"><span class="octicon octicon-link"></span></a>safe-close</h3>

<p><code>./svr.sh close</code>
  <code>ctrl+C</code></p>

<h3>
<a id="logs" class="anchor" href="#logs" aria-hidden="true"><span class="octicon octicon-link"></span></a>logs</h3>

<p>调用方式：</p>

<pre><code>self.info()
self.warn()
self.err()
</code></pre>

<p>提供3种log方式，后面会增加email，参见 conf/svr_conf.py</p>

<pre><code>CONFIG_DICT = {
    # ....

    # log
    'log.console': True,
    'log.console.level': 'INFO',
    'log.console.format': '&lt;%(levelname)s: %(name)s(%(process)d)&gt; [%(filename)s: %(lineno)d] &gt;&gt; %(message)s ',

    'log.syslog': True,
    'log.syslog.level': 'WARN',
    'log.syslog.format': '&lt;%(levelname)s: %(name)s(%(process)d)&gt; [%(filename)s: %(lineno)d] &gt;&gt; %(message)s ',

    'log.file_log': '/home/ghost/code/log/my_svr.log',
    'log.file_log.level': 'WARN',
    'log.file_log.format': '&lt;%(levelname)s: %(name)s(%(process)d)&gt; [%(filename)s: %(lineno)d] &gt;&gt; %(message)s ',
}
</code></pre>

<h3>
<a id="timer" class="anchor" href="#timer" aria-hidden="true"><span class="octicon octicon-link"></span></a>timer</h3>

<p>通过调用<code>add_timer</code> 和 <code>remove_timer</code>增加和减少timer，timer之间是串行的，不需要用锁，timer和run之间的锁需要开发者根据需求自己处理。已实现如下timer:</p>

<ul>
<li>PeriodTimer 周期定时器</li>
<li>FixedPeriodTimer 固定时间点的定时器，每小时/每天/每分钟执行</li>
<li>可以继承 _AbstractTimer 实现新的定时器（见 PyServer/bin/svr_timer.py）</li>
</ul>

<p>通过配置调整timer精度：</p>

<pre><code>    CONFIG_DICT = {
        ....

        # timer 设置 (单位:s)
        'svr.timer.min_span': 1,  # timer的精度

        ....
    }
</code></pre>

<h3>
<a id="summary--auto-exit" class="anchor" href="#summary--auto-exit" aria-hidden="true"><span class="octicon octicon-link"></span></a>summary &amp; auto-exit</h3>

<ul>
<li>超过一定时间没有调用<code>running_report</code> 函数，认为程序挂死，自动退出</li>
<li>
<p>每隔一定时间自动调用<code>get_summmary</code> 函数，将返回结果输出到日志中</p>

<pre><code>CONFIG_DICT = {
    ...

    # timer 设置 (单位:s)
    'svr.timer.min_span': 1,  # timer的精度
    'svr.timer.run_status_check_time_span': 60,  # 最大无响应时间，超过这个时间没有相应，自动退出
    'svr.timer.summary_output_time_point': 'M',  # 报告输出类型 D(per day), H(per hour), M(per minute)

    ...
}
</code></pre>
</li>
</ul>

<h2>
<a id="tasks" class="anchor" href="#tasks" aria-hidden="true"><span class="octicon octicon-link"></span></a>tasks</h2>

<h3>
<a id="done" class="anchor" href="#done" aria-hidden="true"><span class="octicon octicon-link"></span></a>done</h3>

<ul>
<li>动态更新代码和配置 <code>svr.sh reload</code>
</li>
<li>安全退出 <code>svr.sh close</code>
</li>
<li>syslog, consolelog日志处理</li>
<li>多种类型timer</li>
<li>周期性输出统计信息</li>
<li>一定时间不响应，自动退出</li>
<li>错误统一处理</li>
<li>输出日志到特定目录</li>
<li>不同日志不同级别</li>
<li>自动生成重启和关闭脚本 svr.sh</li>
<li><h3>
<a id="todo" class="anchor" href="#todo" aria-hidden="true"><span class="octicon octicon-link"></span></a>todo</h3></li>
<li><p>写注释，更新readme !!!</p></li>
<li>响应特定的信号，输出最后一统计信息</li>
<li>响应特定的信号，输出当前配置</li>
<li>邮件通知</li>
<li>timeout task</li>
<li>retry task</li>
<li>更新需要用锁</li>
<li>checkpoint(LATER)</li>
<li>master-slave(LATER)</li>
<li>网页监控(LATER)</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/GhostZCH/Tiny">Tiny</a> is maintained by <a href="https://github.com/GhostZCH">GhostZCH</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
